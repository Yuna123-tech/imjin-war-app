<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>임진왜란 주변 정세 파악 앱</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Noto Sans KR 폰트 임포트 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
    }
    .animate-pulse-slow {
      animation: pulse 4s infinite cubic-bezier(0.4, 0, 0.6, 1);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 및 ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel CDN (JSX 변환용) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    // Firebase 관련 전역 변수들은 GitHub Pages 환경에서 직접 사용할 수 없습니다.
    // 하지만 코드 구조 유지를 위해 변수 선언은 유지합니다.
    // 실제 Firebase 연동을 위해서는 별도의 Firebase 프로젝트 설정 및 SDK 초기화가 필요합니다.
    // 현재는 기능 상으로 사용되지 않으므로, 아래 선언은 안전하게 유지됩니다.
    const __app_id = 'imjin-war-geopolitics-app'; // GitHub에서는 고정된 값 사용
    const __firebase_config = '{}'; // Firebase config는 이 환경에서 사용되지 않음
    const __initial_auth_token = null; // 초기 인증 토큰도 이 환경에서 사용되지 않음


    function App() {
      const [loading, setLoading] = React.useState(false);
      const [geoInfo, setGeoInfo] = React.useState({ japan: [], ming: [] }); // 변경: 배열로 받도록
      const [currentQuizQuestion, setCurrentQuizQuestion] = React.useState(0);
      const [selectedAnswer, setSelectedAnswer] = React.useState(null);
      const [quizFeedback, setQuizFeedback] = React.useState('');
      const [showQuizResult, setShowQuizResult] = React.useState(false);

      // Firebase 설정 (GitHub Pages에서는 직접 연결되지 않음)
      const [db, setDb] = React.useState(null);
      const [auth, setAuth] = React.useState(null);
      const [userId, setUserId] = React.useState(null);
      const [isAuthReady, setIsAuthReady] = React.useState(false);

      React.useEffect(() => {
        // GitHub Pages 환경에서는 Firebase 초기화가 실제 동작하지 않으므로,
        // 더미 데이터를 설정하여 앱이 실행되도록 합니다.
        // 실제 Firebase 연동을 위해서는 Firebase SDK를 npm으로 설치하고
        // 빌드 과정을 거쳐야 합니다.
        console.log("Firebase initialization does not work directly in GitHub Pages environment.");
        setDb({}); // Dummy object
        setAuth({}); // Dummy object
        setUserId('guest-user-github'); // Dummy user ID
        setIsAuthReady(true);
      }, []);

      // Function to call Gemini API for historical context
      const getHistoricalContext = async (country) => {
        setLoading(true);
        let chatHistory = [];
        // Enhanced prompt to explain political, social, and economic situations just before the Imjin War at an elementary school level,
        // focusing on why they were involved or affected by the war with Joseon,
        // and using simple, short sentences. Brief mention of key figures or interesting events is welcome.
        // Each sentence should be separated into a new paragraph.
        const prompt = `초등학생 수준으로 임진왜란 직전의 ${country}의 정치, 사회, 경제 상황을 아주 쉽고 재미있게 설명해주세요. 왜 그들이 조선과의 전쟁에 참여하거나 영향을 받았을지에 초점을 맞춰 간단하고 짧은 문장들로 구성해주세요. 호기심을 자극하는 주요 인물이나 흥미로운 사건을 간략히 언급할 수 있다면 더 좋습니다. 각 문장을 새로운 문단으로 구분해서 제시해주세요.`;

        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = {
            contents: chatHistory,
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: { "type": "STRING" }
                }
            }
        };
        // In GitHub Pages, it's not secure to put API keys directly in the code.
        // Here, it's left as an empty string for demonstration. In actual deployment,
        // it should be handled by a backend or managed via environment variables.
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();

          if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            const text = result.candidates[0].content.parts[0].text;
            try {
                const parsedJson = JSON.parse(text); // Parse JSON string
                setGeoInfo(prev => ({ ...prev, [country === '일본' ? 'japan' : 'ming']: parsedJson }));
            } catch (parseError) {
                console.error("JSON parsing error:", parseError);
                setGeoInfo(prev => ({ ...prev, [country === '일본' ? 'japan' : 'ming']: ['정보를 가져왔으나 파싱에 실패했습니다.'] }));
            }
          } else {
            console.error("Unexpected API response structure:", result);
            setGeoInfo(prev => ({ ...prev, [country === '일본' ? 'japan' : 'ming']: ['정보를 가져오는 데 실패했습니다.'] }));
          }
        } catch (error) {
          console.error("Error fetching historical context:", error);
          setGeoInfo(prev => ({ ...prev, [country === '일본' ? 'japan' : 'ming']: ['정보를 가져오는 데 오류가 발생했습니다. (API 키 문제 또는 네트워크 오류일 수 있습니다)'] }));
        } finally {
          setLoading(false);
        }
      };

      // Quiz data (including questions related to Japan and Ming Dynasty)
      const quizQuestions = [
        {
          question: "임진왜란을 일으킨 일본의 장수는 누구일까요?",
          options: ["도쿠가와 이에야스", "도요토미 히데요시", "오다 노부나가", "시마즈 요시히로"],
          answer: "도요토미 히데요시",
        },
        {
          question: "임진왜란 당시 일본이 조선을 침략하려 했던 가장 큰 이유는 무엇일까요?",
          options: ["조선의 문화를 배우고 싶어서", "명나라를 정복하고 싶어서", "조선과 무역을 하고 싶어서", "농사를 짓기 좋은 땅을 찾아서"],
          answer: "명나라를 정복하고 싶어서",
        },
        {
          question: "임진왜란 당시 조선을 도왔던 나라는 어디일까요?",
          options: ["청나라", "명나라", "몽골", "베트남"],
          answer: "명나라",
        },
        {
          question: "임진왜란 직전 명나라가 가지고 있던 가장 큰 국내 문제는 무엇일까요?",
          options: ["평화로운 시대였다", "돈이 많았다", "농민 반란과 재정 문제가 있었다", "이웃 나라와 사이가 좋았다"],
          answer: "농민 반란과 재정 문제가 있었다",
        },
        {
          question: "명나라는 왜 임진왜란에 참여하여 조선을 도왔을까요?",
          options: ["조선을 아주 좋아해서", "일본이 강해지는 것을 막고 싶어서", "조선의 바다를 차지하고 싶어서", "새로운 친구를 사귀고 싶어서"],
          answer: "일본이 강해지는 것을 막고 싶어서",
        },
        {
          question: "임진왜란 이후 명나라가 겪게 된 가장 큰 어려움은 무엇일까요?",
          options: ["더 부유해졌다", "새로운 영토를 얻었다", "전쟁으로 많은 돈을 써서 나라가 약해졌다", "문화가 발전했다"],
          answer: "전쟁으로 많은 돈을 써서 나라가 약해졌다",
        },
      ];

      const handleAnswerSelect = (option) => {
        setSelectedAnswer(option);
        setQuizFeedback(''); // Clear feedback on answer selection
        setShowQuizResult(false);
      };

      const checkAnswer = () => {
        if (selectedAnswer === null) {
          setQuizFeedback('정답을 선택해주세요!');
          return;
        }
        if (selectedAnswer === quizQuestions[currentQuizQuestion].answer) {
          setQuizFeedback('정답입니다! 🎉');
        } else {
          setQuizFeedback(`오답입니다. 정답은 '${quizQuestions[currentQuizQuestion].answer}' 입니다. 🥲`);
        }
        setShowQuizResult(true);
      };

      const nextQuestion = () => {
        setSelectedAnswer(null);
        setQuizFeedback('');
        setShowQuizResult(false);
        if (currentQuizQuestion < quizQuestions.length - 1) {
          setCurrentQuizQuestion(prev => prev + 1);
        } else {
          setCurrentQuizQuestion(0); // Loop back to the first question if all questions are answered
          setQuizFeedback('모든 퀴즈를 푸셨습니다! 처음부터 다시 시작합니다. ✨');
        }
      };

      return (
        <>
          <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center p-4">
            <div className="relative bg-white p-8 rounded-xl shadow-2xl max-w-4xl mx-auto border-4 border-purple-500">
              <h1 className="text-4xl font-bold text-gray-800 mb-6 text-center">⚔️ 임진왜란 이전 주변 정세 파악</h1>
              <p className="text-lg text-gray-700 mb-0 text-center">
                임진왜란이 일어나기 직전, 이웃 나라 일본과 명나라는 어떤 상황이었을까요?
              </p>
              <p className="text-lg text-gray-700 mb-6 text-center">
                궁금한 나라의 버튼을 눌러 자세한 이야기를 들어봅시다!
              </p>

              <div className="flex flex-col md:flex-row gap-6 mb-8 justify-center">
                <button
                  onClick={() => getHistoricalContext('일본')}
                  className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 active:scale-95 flex items-center justify-center"
                  disabled={loading}
                >
                  {loading && geoInfo.japan.length === 0 ? (
                    <span className="flex items-center justify-center">
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      정보 가져오는 중...
                    </span>
                  ) : (
                    <>🇯🇵 일본 정세 파악하기</>
                  )}
                </button>
                <button
                  onClick={() => getHistoricalContext('명나라')}
                  className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 active:scale-95 flex items-center justify-center"
                  disabled={loading}
                >
                  {loading && geoInfo.ming.length === 0 ? (
                     <span className="flex items-center justify-center">
                     <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                       <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                       <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                     </svg>
                     정보 가져오는 중...
                   </span>
                  ) : (
                    <>🇨🇳 명나라 정세 파악하기</>
                  )}
                </button>
              </div>

              {(geoInfo.japan.length > 0 || geoInfo.ming.length > 0) ? (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                  {geoInfo.japan.length > 0 && (
                    <div className="bg-blue-50 p-6 rounded-xl shadow-md border border-blue-200 flex flex-col">
                      <h3 className="text-2xl font-bold text-blue-800 mb-4 text-center">🇯🇵 일본의 상황</h3>
                      {geoInfo.japan.map((paragraph, index) => (
                        <p key={`jp-${index}`} className="text-gray-700 leading-relaxed text-base mb-2 text-justify">
                          {paragraph}
                        </p>
                      ))}
                      <a href="http://contents.nahf.or.kr/id/NAHF.edeao.d_0004_0010_0010" target="_blank" rel="noopener noreferrer"
                         className="mt-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105 active:scale-95 text-center block w-full mt-4">
                        더 많은 정보 보러 가기 (동북아역사넷)
                      </a>
                    </div>
                  )}
                  {geoInfo.ming.length > 0 && (
                    <div className="bg-red-50 p-6 rounded-xl shadow-md border border-red-200 flex flex-col">
                      <h3 className="text-2xl font-bold text-red-800 mb-4 text-center">🇨🇳 명나라의 상황</h3>
                      {geoInfo.ming.map((paragraph, index) => (
                        <p key={`mg-${index}`} className="text-gray-700 leading-relaxed text-base mb-2 text-justify">
                          {paragraph}
                        </p>
                      ))}
                      <a href="https://archives.warmemo.or.kr:8443/exbi/prmn/exbiPrmnList.do?MID=UM00032&ctgryClfcCd=70" target="_blank" rel="noopener noreferrer"
                         className="mt-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl shadow-md transition duration-300 transform hover:scale-105 active:scale-95 text-center block w-full mt-4">
                        더 많은 정보 보러 가기 (전쟁기념관)
                      </a>
                    </div>
                  )}
                </div>
              ) : (
                <div className="text-center text-gray-500 text-lg mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200 animate-pulse-slow">
                  위 버튼을 눌러 임진왜란 직전 각 나라의 정세를 확인해 보세요!
                </div>
              )}

              {/* 퀴즈 섹션 */}
              <div className="mt-12 p-8 bg-purple-50 rounded-xl shadow-lg border-4 border-purple-300">
                <h2 className="text-3xl font-bold text-purple-700 mb-6 text-center">🧠 역사 퀴즈 풀기!</h2>
                <div className="text-center mb-6">
                  <p className="text-xl font-semibold text-gray-800 mb-4">
                    {quizQuestions[currentQuizQuestion].question}
                  </p>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {quizQuestions[currentQuizQuestion].options.map((option, index) => (
                      <button
                        key={index}
                        onClick={() => handleAnswerSelect(option)}
                        className={`p-3 rounded-lg border-2 ${selectedAnswer === option ? 'bg-blue-200 border-blue-500' : 'bg-gray-100 border-gray-300'} hover:bg-blue-100 transition duration-200`}
                      >
                        {option}
                      </button>
                    ))}
                  </div>
                  <div className="mt-6">
                    <button
                      onClick={checkAnswer}
                      className="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-5 rounded-xl shadow-md transition duration-300 transform hover:scale-105 active:scale-95 mr-4"
                    >
                      정답 확인
                    </button>
                    <button
                      onClick={nextQuestion}
                      className="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-xl shadow-md transition duration-300 transform hover:scale-105 active:scale-95"
                    >
                      다음 문제
                    </button>
                  </div>
                  {showQuizResult && (
                    <p className={`mt-4 text-xl font-bold ${quizFeedback.includes('정답입니다') ? 'text-green-700' : 'text-red-700'}`}>
                      {quizFeedback}
                    </p>
                  )}
                </div>
              </div>

              {isAuthReady && (
                <p className="mt-8 text-sm text-gray-500 text-center">
                  사용자 ID: {userId}
                </p>
              )}
            </div>
          </div>
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
